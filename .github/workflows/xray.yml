name: xray
on: [workflow_dispatch] # æ‰‹åŠ¨æŒ‰é’®è§¦å‘

jobs:
  high-speed-vps:
    runs-on: ubuntu-latest
    steps:
      # 1. è¿žæŽ¥åˆ° Tailscale ç½‘ç»œ
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.zeigonfo }}
          version: 1.94.1
          # ç»™å®ƒèµ·ä¸ªåå­—ï¼Œæ–¹ä¾¿ä½ åœ¨åˆ—è¡¨é‡Œè®¤å‡ºæ¥
          hostname: github-action-runner

      # 2. å¼€å¯ SSH å¹¶è®¾ç½®å¯†ç 
      - name: Enable SSH & Set Password
        run: |
          # è®¾ç½®ç”¨æˆ· 'runner' çš„å¯†ç ä¸º '123456'
          # æ³¨æ„ï¼šè¿™æ˜¯ä¸´æ—¶çŽ¯å¢ƒï¼Œå¯†ç ç®€å•ç‚¹æ²¡äº‹ï¼Œåæ­£åªæœ‰ä½ èƒ½è¿ž
          echo "runner:123456" | sudo chpasswd
          
          # å¯åŠ¨ SSH æœåŠ¡
          sudo systemctl start ssh

          curl -L -o cloudflared \
          https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          sudo install -m 0755 cloudflared /usr/local/bin/cloudflared
          
          sudo mkdir -p /etc/cloudflared
          sudo mkdir -p /home/runner/.cloudflared && \
          sudo tee /home/runner/.cloudflared/ee496e78-c29d-45aa-a9b9-19f55028407e.json > /dev/null << 'EOF'
          {"AccountTag":"d480fa1824294b62aa07375367eb6979","TunnelSecret":"8lZNeSCRTCXFqek5qL+d0/pjeHRUyk2bXpXy6fY77hg=","TunnelID":"ee496e78-c29d-45aa-a9b9-19f55028407e","Endpoint":""}
          EOF
          
          sudo tee /etc/cloudflared/config.yml > /dev/null << 'EOF'
          tunnel: ee496e78-c29d-45aa-a9b9-19f55028407e
          credentials-file: /home/runner/.cloudflared/ee496e78-c29d-45aa-a9b9-19f55028407e.json
          
          ingress:
            - hostname: proxy2.zeigonfo.cc.cd
              service: http://127.0.0.1:10000
            - service: http_status:404
          EOF
          
          sudo su
          bash <(curl -Ls https://github.com/XTLS/Xray-install/raw/main/install-release.sh)
          
          sudo tee /usr/local/etc/xray/config.json > /dev/null << 'EOF'
          {
            "inbounds": [
              {
                "listen": "127.0.0.1",
                "port": 10000,
                "protocol": "vless",
                "settings": {
                  "clients": [
                    {
                      "id": "44444444-4444-4444-8888-888888888888"
                    }
                  ],
                  "decryption": "none"
                },
                "streamSettings": {
                  "network": "ws",
                  "security": "none",
                  "wsSettings": {
                    "path": "/ws"
                  }
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom"
              }
            ]
          }
          EOF
          
          
          sudo systemctl enable xray && sudo systemctl restart xray && sudo cloudflared service install && sudo systemctl restart cloudflared
          
                    
          # æ˜¾ç¤ºå®ƒçš„ Tailscale IP åœ°å€ï¼Œæ–¹ä¾¿ä½ å¤åˆ¶
          echo "=========================================="
          echo "ðŸŽ‰ è¿žæŽ¥æˆåŠŸï¼"
          echo "ä½ çš„ Runner IP åœ°å€æ˜¯ï¼š"
          tailscale ip -4
          echo "=========================================="

      # 3. ä¿æŒè¿è¡Œ (æœ€å¤š 6 å°æ—¶)
      - name: Keep Alive
        run: sleep 21600
