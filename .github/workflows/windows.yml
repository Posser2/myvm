name: Windows RDP via Tailscale (Fixed)
on: [workflow_dispatch]

jobs:
  windows-remote:
    runs-on: windows-latest
    steps:
      # 1. æ‰‹åŠ¨ä¸‹è½½å¹¶å®‰è£… Tailscale (ä»£æ›¿å®˜æ–¹æ’ä»¶)
      - name: Install Tailscale (Manual)
        shell: powershell
        run: |
          Write-Host "æ­£åœ¨ä¸‹è½½ Tailscale..."
          Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
          
          Write-Host "æ­£åœ¨å®‰è£… Tailscale..."
          # /quiet è¡¨ç¤ºé™é»˜å®‰è£…ï¼Œä¸å¼¹çª—
          Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/quiet", "/norestart" -Wait
          
          Write-Host "å®‰è£…å®Œæˆï¼"

      # 2. ç™»å½• Tailscale
      - name: Connect to Tailscale
        shell: powershell
        run: |
          # Windows ä¸‹ Tailscale çš„é»˜è®¤å®‰è£…è·¯å¾„æ˜¯ C:\Program Files\Tailscale\
          # --unattended è¡¨ç¤ºæ— äººå€¼å®ˆæ¨¡å¼
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "${{ secrets.zeigonfo }}" --hostname "github-windows-box" --unattended

      # 3. é…ç½® Windows è¿œç¨‹æ¡Œé¢ç¯å¢ƒ
      - name: Setup RDP & Password
        shell: powershell
        run: |
          # è®¾ç½®å¯†ç  (æ³¨æ„ï¼šWindows å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å’Œæ•°å­—)
          net user admin "Aa@111111" 

          # ä¿®æ”¹æ³¨å†Œè¡¨å¼€å¯ RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0

          # å¼€å¯é˜²ç«å¢™ç«¯å£ 3389
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # æ˜¾ç¤º IP åœ°å€
          Write-Host "=========================================="
          Write-Host "ğŸ‰ Windows ç¯å¢ƒå‡†å¤‡å°±ç»ªï¼"
          Write-Host "ä½ çš„ Tailscale IP åœ°å€æ˜¯ï¼š"
          & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "ç”¨æˆ·å: admin"
          Write-Host "å¯†ç :   Aa@111111"
          Write-Host "=========================================="

      # 4. ä¿æŒè¿è¡Œ (6 å°æ—¶)
      - name: Keep Alive
        run: Start-Sleep -Seconds 21600
